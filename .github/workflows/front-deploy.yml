name: vue-builder
on:
  push:
    branches: front-dev

jobs:
  build:
    name: vue-builder
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Install Dependencies
        run: npm install
        working-directory: front

      - name: Build
        run: npm run build
        working-directory: front

      - name: Move deploy script
        run: cp scripts/*.sh ./front/dist/

      - name: zip dist folder
        run: cd front && zip -r ./dist.zip ./dist/*

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          push: true
          tags: docker.io/${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_FRONT_REPOSITORY }}:latest

      - name: Load balancer scp dist folder
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.NCP_SERVER1_HOST}}
          username: ${{ secrets.NCP_SERVER1_HOST}}
          password: ${{ secrets.NCP_SERVER1_HOST}}
          port: ${{ secrets.NCP_SERVER1_HOST}}
          source: "./front/dist/*"
          target: "~/"
          overwrite: true

      - name: front image update
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.NCP_SERVER1_HOST  }}
          username: ${{ secrets.NCP_SERVER1_USERNAME  }}
          password: ${{ secrets.NCP_SERVER1_PASSWORD  }}
          port: ${{ secrets.NCP_SERVER1_PORT  }}
          script: |
            cd ~/deploy/
            sudo docker-compose pull
            sudo docker-compose restart front
